# Протокол разработки WaySwitch (Project RAG Context)

Этот файл служит оперативной памятью проекта для LLM-агента. Обновляется после каждого значимого этапа разработки.

## Текущий статус
- **Версия**: 0.1-alpha (прототип)
- **Целевая платформа**: Linux (GNOME + Wayland)
- **Язык**: Python 3
- **Метод перехвата**: `evdev` (прямое чтение из `/dev/input/`)
- **Метод ввода**: `uinput` (виртуальная клавиатура)
- **Метод переключения раскладки**: `gsettings` (D-Bus интеграция с GNOME)

## Архитектура
1. **daemon.py**: Низкоуровневый демон. Ведет буфер слова, анализирует триграммы, выполняет удаление (Backspace) и повторный ввод при обнаружении ошибки или по нажатию F12.
2. **gui.py**: Интерфейс настроек на GTK4/Libadwaita.
3. **trigrams.json**: База знаний "невозможных" сочетаний (N-граммы) для автоматического определения неверной раскладки.
4. **install.sh**: Скрипт развертывания (создание папок, копирование, настройка автозагрузки в `.config/autostart`).

## История изменений (Сессия 11.02.2026)
1. **Инициализация**: Создана структура проекта для обхода ограничений Wayland через `evdev`.
2. **Реализация GUI**: Написан современный интерфейс в стиле GNOME 45+.
3. **Интеграция с GNOME**: Добавлена логика смены `current` раскладки в `org.gnome.desktop.input-sources`, что обеспечивает синхронизацию с системной иконкой.
4. **Умная логика**: Внедрена система триграмм. Программа теперь исправляет слово "на лету", не дожидаясь пробела, если видит характерные для другого языка сочетания букв.
5. **Оптимизация**: Тайминги `uinput` настроены на 5мс для мгновенного визуального эффекта.
6. **Документация**: Создан README.md и requirements.txt для публикации на GitHub.

## Принятые решения (Convention)
- Используем `grab()` на устройстве ввода, чтобы избежать дублирования символов (программа сама решает, пробросить символ или заменить его).
- Раскладка переключается по кругу (циклически) среди всех добавленных в систему источников.
- Для работы без sudo пользователь должен быть в группе `input`.

## План на следующие сессии
- [ ] Добавить поддержку Shift/Caps Lock в буфере и при повторном вводе.
- [ ] Реализовать список исключений (программ, где не нужен авто-свитчер).
- [ ] Добавить звуковое уведомление при исправлении (опционально).
- [ ] Расширить базу триграмм на основе данных из `Easy Switcher`.

---
*Сохраняйте этот файл при переносе проекта. Он поможет мне быстро продолжить работу с любой точки.*
